import React from 'react';
import { useContext, useEffect, useState } from 'react';
import { useParams } from 'react-router-dom';
import RegistryContext from '../store/registeryContext';
import { Alert, Button } from '@patternfly/react-core';
import AsyncComponent from '@redhat-cloud-services/frontend-components/AsyncComponent';
import { getDevice, getImageSet } from '../api/edge/imagesInfo';

import { InProgressIcon } from '@patternfly/react-icons';
const VulnerabilityEdgePrompt = (setUpdateModal) => {
  const { inventoryId } = useParams();
  const [imageId, setImageID] = useState(null);
  const [deviceData, setDeviceData] = useState(null);
  useEffect(() => {
    (async () => {
      const device = await getDevice(inventoryId);
      setDeviceData(device);
      setImageID(deviceData?.ImageInfo?.Image?.ID);
      const params = {
        id: 'view',
        q: { id: deviceData?.ImageInfo?.ImageSetID },
      };
      const resp = await getImageSet(params);
      console.log(resp);
    })();
  });
  const { getRegistry } = useContext(RegistryContext);

  const [updateCveModal, setUpdateCveModal] = useState({
    isOpen: false,
    imageId: null,
    cveCount: 0,
  });
  console.log(updateCveModal);
  const [CVEs, setCVEs] = useState(null);
  const [newImageStatus, setNewImageStatus] = useState(null);
  setNewImageStatus(null);
  const [activeAlert, setActiveAlert] = useState('noAlert');

  useEffect(() => {
    setUpdateCveModal((prevState) => ({ ...prevState, imageId: imageId }));
  }, [imageId]);
  console.log(imageId);
  const getActiveAlert = (
    CVEs,
    deviceData,
    newImageStatus,
    imageId,
    prevState
  ) => {
    if (CVEs?.isLoading || CVEs?.meta?.filter || !deviceData) {
      return prevState;
    }
    if (!CVEs?.data?.length > 0 || !imageId) {
      return 'noAlert';
    }
    if (
      deviceData?.UpdateTransactions[0]?.Status === 'BUILDING' ||
      deviceData?.UpdateTransactions[0]?.Status === 'CREATED'
    ) {
      return 'systemUpdating';
    }
    if (deviceData?.Device?.UpdateAvailable) {
      return 'updateDevice';
    }
    if (newImageStatus === 'BUILDING' || newImageStatus === 'CREATED') {
      return 'imageBuilding';
    }
    return 'updateImage';
  };
  useEffect(() => {
    !CVEs?.isLoading &&
      !CVEs?.meta?.filter &&
      setUpdateCveModal((prevState) => ({
        ...prevState,
        cveCount: CVEs?.data?.length,
      }));

    setActiveAlert((prevState) =>
      getActiveAlert(CVEs, deviceData, newImageStatus, imageId, prevState)
    );
  }, [CVEs, deviceData, newImageStatus, imageId]);

  const handleUpdateImageButton = () => {
    setUpdateCveModal((preState) => ({
      ...preState,
      isOpen: true,
    }));
  };

  const handleUpdateDeviceButton = () => {
    setUpdateModal((preState) => ({
      ...preState,
      isOpen: true,
    }));
  };
  const alerts = {
    updateImage: (
      <Alert
        className="pf-u-mb-md"
        variant="info"
        isInline
        title="To remediate CVEs, update the image."
        actionLinks={
          <Button
            className="pf-u-mt-sm"
            isSmall
            onClick={handleUpdateImageButton}
          >
            Update Image
          </Button>
        }
      />
    ),
    imageBuilding: (
      <Alert
        className="pf-u-mb-md"
        customIcon={<InProgressIcon />}
        variant="info"
        isInline
        title="Image build in progress. Once completed, you'll need to update your system."
      />
    ),
    updateDevice: (
      <Alert
        className="pf-u-mb-md"
        variant="warning"
        isInline
        title=" Image build completed. Update system to the newest image version to remediate CVEs."
        actionLinks={
          <Button
            className="pf-u-mt-sm"
            isSmall
            onClick={handleUpdateDeviceButton}
          >
            Update system
          </Button>
        }
      />
    ),
    systemUpdating: (
      <Alert
        className="pf-u-mb-md"
        customIcon={<InProgressIcon />}
        variant="info"
        isInline
        title="System updating. No additional actions required."
      />
    ),
    noAlert: <></>,
  };

  return (
    <section className="add-100vh pf-l-page__main-section pf-c-page__main-section">
      {alerts[activeAlert]}
      <AsyncComponent
        appName="vulnerability"
        module="./SystemDetail"
        getRegistry={getRegistry}
        customIntlProvider
        entity={{ id: inventoryId }}
        canSelect={false}
        canEditPairStatus={false}
        canManageColumns={false}
        linkToCustomerPortal
        defaultColumns={[
          'synopsis',
          'public_date',
          'impact',
          'cvss_score',
          'advisory',
        ]}
        filters={[
          'filter',
          'security_rule',
          'known_exploit',
          'impact',
          'cvss_score',
          'advisory',
        ]}
        customAction={(cve) => {
          setCVEs(cve);
        }}
      />
    </section>
  );
};

export default VulnerabilityEdgePrompt;
